<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MediAlert - Health Report</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script src="theme.js"></script>
    <style>
      /* MODIFIED: Changed to a responsive layout */
      .report-generator {
        display: grid;
        grid-template-columns: 1fr; /* Mobile first: stack vertically */
        gap: 1rem;
        margin-bottom: 2rem;
      }
      /* Media query for tablet and desktop view */
      @media (min-width: 600px) {
        .report-generator {
          grid-template-columns: 1fr 1fr auto; /* 3-column layout on wider screens */
          align-items: flex-end;
        }
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }
      .form-group input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--bg-color);
        color: var(--text-color);
      }
      .btn-primary {
        padding: 0.75rem 1.5rem;
        border: none;
        background-color: var(--primary-color);
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s;
      }
      .btn-primary:hover {
        background-color: #4338ca;
      }
      #report-content {
        display: none; /* Initially hidden */
      }
      .report-section {
        margin-bottom: 2.5rem;
      }
      .report-section h3 {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.25rem;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
      }
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }
      .summary-item {
        background-color: var(--bg-color);
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
      }
      .summary-item .label {
        font-size: 0.9rem;
        color: var(--text-light);
      }
      .summary-item .value {
        font-size: 1.5rem;
        font-weight: 600;
        text-transform: capitalize;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
      }
      .data-table th,
      .data-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
      }
      .data-table th {
        background-color: var(--bg-color);
      }
      .status-taken {
        color: #10b981;
        font-weight: 500;
        text-transform: capitalize;
      }
      .status-missed {
        color: #ef4444;
        font-weight: 500;
        text-transform: capitalize;
      }
      .data-table td:last-child {
        word-break: break-word;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <aside class="sidebar">
        <div class="logo">
          <i class="fa-solid fa-heart-pulse"></i>
          <h2>MediAlert</h2>
        </div>
        <ul class="nav-links">
          <li>
            <a href="index.html"
              ><i class="fa-solid fa-table-columns"></i
              ><span>Dashboard</span></a
            >
          </li>
          <li>
            <a href="add-medicine.html"
              ><i class="fa-solid fa-pills"></i><span>Add Medicine</span></a
            >
          </li>
          <li>
            <a href="journal.html"
              ><i class="fa-solid fa-book-medical"></i><span>Journal</span></a
            >
          </li>
          <li>
            <a href="insight.html"
              ><i class="fa-solid fa-chart-line"></i
              ><span>Health Insights</span></a
            >
          </li>
            <!-- NEW COMMUNITY LINK -->
          <li>
            <a href="community.html"
              ><i class="fa-solid fa-users"></i><span>Community</span></a
            >
          </li>
          <li class="active">
            <a href="report.html"
              ><i class="fa-solid fa-file-pdf"></i><span>Report</span></a
            >
          </li>
           
          <!-- NEW SUBSCRIPTION LINK -->
          <li class="nav-item-premium">
            <a href="subscription.html"
              ><i class="fa-solid fa-crown"></i><span>Subscription</span></a
            >
          </li>
          <li>
            <a href="settings.html"
              ><i class="fa-solid fa-gear"></i><span>Settings</span></a
            >
          </li>
        </ul>
        <div class="user-profile">
          <div class="user-info">
            <h4 id="sidebar-user-name">Guest</h4>
            <small id="sidebar-user-email">email@example.com</small>
          </div>
        </div>
      </aside>

      <main class="main-content">
        <header>
          <h1>Health Report</h1>
          <p>Generate and download your health summary.</p>
        </header>

        <div class="card">
          <div class="report-generator">
            <div class="form-group">
              <label for="start-date">Start Date</label>
              <input type="date" id="start-date" />
            </div>
            <div class="form-group">
              <label for="end-date">End Date</label>
              <input type="date" id="end-date" />
            </div>
            <button id="generate-report-btn" class="btn-primary">
              Generate
            </button>
          </div>
        </div>

        <div id="report-content">
          <div class="card" id="printable-report">
            <div
              class="report-header"
              style="text-align: center; margin-bottom: 2rem"
            >
              <h2>
                Health Report for <span id="report-user-name">Guest</span>
              </h2>
              <p>Period: <span id="report-period"></span></p>
            </div>

            <div class="report-section">
              <h3>
                <i class="fa-solid fa-lightbulb"></i> Health Insights Summary
              </h3>
              <div class="summary-grid">
                <div class="summary-item">
                  <div class="label">Average Mood</div>
                  <div class="value" id="avg-mood">--</div>
                </div>
                <div class="summary-item">
                  <div class="label">Adherence Rate</div>
                  <div class="value" id="meds-adherence">0%</div>
                </div>
                <div class="summary-item">
                  <div class="label">Most Frequent Symptom</div>
                  <div class="value" id="top-symptom">--</div>
                </div>
              </div>
            </div>

            <div class="report-section">
              <h3><i class="fa-solid fa-book-medical"></i> Journal Log</h3>
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Mood</th>
                    <th>Symptoms</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody id="journal-data-log"></tbody>
              </table>
            </div>

            <div class="report-section">
              <h3><i class="fa-solid fa-pills"></i> Medication Log</h3>
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Medication</th>
                    <th>Dosage</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="meds-data-log"></tbody>
              </table>
            </div>
          </div>
          <div style="text-align: right; margin-top: 1rem">
            <button id="download-report-btn" class="btn-primary">
              <i class="fa-solid fa-download"></i> Download as PDF
            </button>
          </div>
        </div>
      </main>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const loggedInUserEmail = localStorage.getItem('loggedInUserEmail');
    
        // If no one is logged in, redirect to the login page
        if (!loggedInUserEmail) {
            window.location.href = 'login.html';
            return; // Stop the script from running further
        }

        // Load settings specific to the logged-in user
        const userSettings = JSON.parse(localStorage.getItem(`userSettings_${loggedInUserEmail}`)) || {};
        const displayName = userSettings.userName || 'Guest';
        
        // Update sidebar
        document.getElementById('sidebar-user-name').textContent = displayName;
        document.getElementById('sidebar-user-email').textContent = loggedInUserEmail;
        const endDateEl = document.getElementById("end-date");
        const startDateEl = document.getElementById("start-date");
        const today = new Date().toISOString().split("T")[0];
        endDateEl.value = today;
        const oneMonthAgo = new Date();
        oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
        startDateEl.value = oneMonthAgo.toISOString().split("T")[0];

        const generateBtn = document.getElementById("generate-report-btn");
        const reportContentEl = document.getElementById("report-content");
        const downloadBtn = document.getElementById("download-report-btn");

        generateBtn.addEventListener("click", () => {
          const startDate = new Date(startDateEl.value);
          const endDate = new Date(endDateEl.value);
          endDate.setHours(23, 59, 59, 999); // Include the entire end day

          // Fetch all required data from localStorage
          const medications =
            JSON.parse(localStorage.getItem("medications")) || [];
          const journalEntries =
            JSON.parse(localStorage.getItem("journalEntries")) || {};

          // Filter data based on the selected date range
          const filteredMeds = medications.filter((m) => {
            const medDate = new Date(m.date || m.id);
            return medDate >= startDate && medDate <= endDate;
          });

          const filteredJournal = Object.entries(journalEntries).filter(
            ([dateKey, entry]) => {
              const entryDate = new Date(dateKey);
              return entryDate >= startDate && entryDate <= endDate;
            }
          );

          populateReport(filteredMeds, filteredJournal);
          reportContentEl.style.display = "block";
        });

        const populateReport = (medData, journalData) => {
          // --- Populate Insights ---
          populateInsights(medData, journalData);

          // --- Populate Journal Log ---
          const journalLogBody = document.getElementById("journal-data-log");
          journalLogBody.innerHTML = "";
          if (journalData.length === 0) {
            journalLogBody.innerHTML =
              '<tr><td colspan="4" style="text-align:center;">No journal entries found.</td></tr>';
          } else {
            journalData.forEach(([date, entry]) => {
              const row = document.createElement("tr");
              const formattedDate = new Date(date).toLocaleDateString();
              const symptoms = entry.symptoms.join(", ") || "None";
              const notes = entry.notes || "N/A";
              row.innerHTML = `<td>${formattedDate}</td><td>${entry.mood}</td><td>${symptoms}</td><td>${notes}</td>`;
              journalLogBody.appendChild(row);
            });
          }

          // --- Populate Medication Log ---
          const medsLogBody = document.getElementById("meds-data-log");
          medsLogBody.innerHTML = "";
          if (medData.length === 0) {
            medsLogBody.innerHTML =
              '<tr><td colspan="5" style="text-align:center;">No medication records found.</td></tr>';
          } else {
            medData.forEach((item) => {
              const row = document.createElement("tr");
              const date = new Date(item.date || item.id).toLocaleDateString();
              const time =
                item.time ||
                new Date(item.date || item.id).toLocaleTimeString();
              const status = `<span class="status-${item.status}">${item.status}</span>`;
              row.innerHTML = `<td>${date}</td><td>${time}</td><td>${item.name}</td><td>${item.dosage}</td><td>${status}</td>`;
              medsLogBody.appendChild(row);
            });
          }

          // --- Report Header ---
          document.getElementById(
            "report-period"
          ).textContent = `${startDateEl.value} to ${endDateEl.value}`;
        };

        const populateInsights = (medData, journalData) => {
          // --- Adherence Calculation ---
          const medsTaken = medData.filter((m) => m.status === "taken").length;
          const totalScheduled = medData.length;
          const adherence = totalScheduled
            ? Math.round((medsTaken / totalScheduled) * 100)
            : 0;
          document.getElementById(
            "meds-adherence"
          ).textContent = `${adherence}%`;

          // --- Mood Calculation ---
          const moodMap = { awful: 1, bad: 2, ok: 3, good: 4, great: 5 };
          const moodScores = journalData.map(
            ([date, entry]) => moodMap[entry.mood]
          );
          let avgMood = "--";
          if (moodScores.length > 0) {
            const avgScore =
              moodScores.reduce((a, b) => a + b, 0) / moodScores.length;
            const moodKeys = Object.keys(moodMap);
            avgMood = moodKeys[Math.round(avgScore) - 1] || "--";
          }
          document.getElementById("avg-mood").textContent = avgMood;

          // --- Symptom Calculation ---
          const symptomFrequency = {};
          journalData.forEach(([date, entry]) => {
            entry.symptoms.forEach((symptom) => {
              symptomFrequency[symptom] = (symptomFrequency[symptom] || 0) + 1;
            });
          });
          const topSymptom = Object.entries(symptomFrequency).sort(
            (a, b) => b[1] - a[1]
          )[0];
          document.getElementById("top-symptom").textContent = topSymptom
            ? topSymptom[0]
            : "None";
        };

        downloadBtn.addEventListener("click", () => {
          const { jsPDF } = window.jspdf;
          const reportElement = document.getElementById("printable-report");
          const reportTitle = `MediAlert_Report_${startDateEl.value}_to_${endDateEl.value}.pdf`;

          html2canvas(reportElement, { scale: 2 }).then((canvas) => {
            const imgData = canvas.toDataURL("image/png");
            const pdf = new jsPDF("p", "mm", "a4");
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

            pdf.addImage(imgData, "PNG", 10, 10, pdfWidth - 20, pdfHeight - 20);
            pdf.save(reportTitle);
          });
        });
      });
    </script>
  </body>
</html>
